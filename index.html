# tsox-coach-v5
ACSM æ™ºèƒ½æ•™ç·´ App
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>T-SOX æ•™ç·´ â€” FITT-VP Final (Modified)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f3f6f5; --card:#ffffff; --primary:#2e7d32; --accent:#ff6f00; --muted:#616161;
  --nav-h:84px; --font-size:18px;
  --added-bg:#c8e6c9; --added-text:#2e7d32;
  --print-primary:#1b5e20; --print-accent:#ff8a65;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:#222;-webkit-font-smoothing:antialiased}
.header{background:linear-gradient(135deg,var(--primary),#1b5e20);color:white;padding:18px;border-radius:0 0 22px 22px;box-shadow:0 6px 20px rgba(27,94,32,0.25);position:sticky;top:0;z-index:60;display:flex;align-items:center;justify-content:space-between}
.header .title{font-weight:800;font-size:1.25rem}
.container{padding:16px;max-width:1100px;margin:0 auto;padding-bottom:140px}
.card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
.label{font-weight:800;color:var(--muted);margin-bottom:8px;font-size:1.03rem}
.result{background:#f5fff6;border-radius:12px;padding:12px;border:1px solid #dff0e6;font-size:var(--font-size);line-height:1.5}
.small{font-size:0.95rem;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center}
.controls{display:flex;gap:8px;margin-top:8px}
.button{padding:10px 14px;border-radius:12px;border:none;background:var(--primary);color:white;font-weight:700;font-size:0.95rem;cursor:pointer}
.button.secondary{background:#455a64}
.button.ghost{background:#fff;color:var(--muted);border:1px solid #eee}
.calendar-wrap{display:flex;gap:12px;flex-wrap:wrap}
.cal-panel{flex:1;min-width:320px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-cell{background:#fff;border-radius:10px;padding:10px;min-height:80px;border:1px solid #eee;position:relative;font-size:0.95rem}
.cal-cell .dateNum{font-weight:700;margin-bottom:8px}
.cal-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:none}
.cal-cell.has .cal-dot{display:block}
.badge{display:inline-block;padding:6px 10px;border-radius:10px;background:var(--primary);color:white;font-weight:800}
.hint{position:fixed;bottom:calc(var(--nav-h) + 6px);left:12px;right:12px;text-align:center;background:white;padding:10px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12);font-weight:700;z-index:50}
.console{position:fixed;left:12px;right:12px;bottom:160px;background:rgba(0,0,0,0.85);color:#00ffb2;padding:10px;border-radius:8px;font-family:monospace;font-size:0.92rem;max-height:140px;overflow:auto;z-index:40}
.fab-bar{position:fixed;bottom:12px;left:12px;right:12px;height:var(--nav-h);display:flex;align-items:center;justify-content:space-between;padding:10px;z-index:60}
.fab{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#43a047,var(--primary));border:4px solid white;color:white;font-size:30px;box-shadow:0 12px 30px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;cursor:pointer}
.fab.listening{background:var(--accent)}
.nav-card{flex:1;background:#fff;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:space-around;gap:8px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.nav-btn{display:flex;flex-direction:column;align-items:center;color:#9e9e9e;font-weight:700;padding:6px 8px;border-radius:8px;cursor:pointer}
.nav-btn.active{color:var(--primary);background:rgba(46,125,50,0.06)}
.equip-info{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:white;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.25);z-index:120;max-width:92%;display:none}
.equip-info h3{margin:0 0 8px 0}
.recommend-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.reco-card{background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.reco-left{max-width:68%}
.reco-meta{font-size:0.95rem;color:var(--muted)}
.chart-card{height:320px}
.toast{position:fixed;right:16px;bottom:110px;background:#323232;color:white;padding:10px 14px;border-radius:8px;z-index:200;opacity:0;transform:translateY(8px);transition:all .28s}
.toast.show{opacity:1;transform:translateY(0)}
.added-btn{background:var(--added-bg);color:var(--added-text);border:1px solid #a5d6a7}
.tab-page{display:none}
.tab-page.active{display:block}
.lang-row{display:flex;gap:8px;align-items:center}
.lang-btn{padding:6px 10px;border-radius:8px;border:1px solid #eee;background:white;cursor:pointer}
.lang-btn.active{background:#efebe9}
.add-all{margin-top:10px}
@media(max-width:760px){ .container{padding:12px} .cal-panel{min-width:100%} .cal-cell{min-height:74px} .console{display:none} .equip-info{width:92%} }
@media print {
  body{background:#fff}
  .fab-bar, .hint, .toast, .console, .nav-card { display:none !important; }
}
</style>
</head>
<body>
  <header class="header">
    <div class="title">T-SOX ç’°ç‹€é‹å‹•ç³»çµ± â€” æ™ºèƒ½æ•™ç·´</div>
    <div class="small" id="bmi">BMI: --</div>
  </header>

  <main class="container">
    <!-- SURVEY PAGE -->
    <section id="page-survey" class="tab-page active">
      <section class="card">
        <div class="label">å•è¨ºé€²åº¦</div>
        <div id="progress" class="large-text">å°šæœªé–‹å§‹</div>
        <div class="small" style="margin-top:8px">èªéŸ³ç‹€æ…‹ï¼š<span id="voiceState">å¾…å•Ÿå‹•</span></div>
      </section>

      <section class="card">
        <div class="label">å•è¨ºæ‘˜è¦ï¼ˆå³æ™‚ï¼‰</div>
        <pre id="answersView" class="result">å°šç„¡å•è¨ºè³‡æ–™</pre>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button id="btnClear" class="button ghost">æ¸…é™¤å•è¨ºè³‡æ–™</button>
          <div style="margin-left:auto" class="lang-row">
            <div class="small">èªè¨€ï¼š</div>
            <button id="micZhBtn" class="lang-btn active">è¯èª</button>
            <!-- å°èªæŒ‰éˆ•å·²ç§»é™¤ï¼ˆä¾ä½¿ç”¨è€…æŒ‡ç¤ºï¼‰ -->
          </div>
        </div>
      </section>

      <section id="prescriptionCard" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="label">æ•™ç·´è™•æ–¹ï¼ˆåˆ†é …å»ºè­°ï¼‰</div>
            <div id="rxSummary" class="big"></div>
          </div>
          <div style="text-align:right">
            <div class="badge" id="rxBadge">å»ºè­°</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button id="addAllBtn" class="button add-all">ä¸€éµåŠ å…¥å…¨éƒ¨åˆ°ä»Šæ—¥è¡Œäº‹æ›†</button>
          <button id="exportAllBtn" class="button ghost" style="margin-left:8px">åŒ¯å‡ºå…¨éƒ¨è™•æ–¹ PDF</button>
        </div>

        <div id="rxPlan" style="margin-top:12px;font-size:1.02rem"></div>

        <div style="margin-top:10px">
          <div class="label">åˆ†é …å»ºè­°ï¼ˆæ¯é …å¯å–®ç¨åŠ å…¥è¡Œäº‹æ›†ï¼‰</div>
          <div id="recommendList" class="recommend-list"></div>
        </div>
      </section>
    </section>

    <!-- CALENDAR PAGE -->
    <section id="page-calendar" class="tab-page">
      <section class="card">
        <div class="label">è¡Œäº‹æ›†ï¼ˆæœˆæª¢è¦–ï¼‰</div>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevMonth" class="button ghost">â—€</button>
            <div id="calHeader" class="day-title large-text">--</div>
            <button id="nextMonth" class="button ghost">â–¶</button>
          </div>
          <div style="margin-left:auto" class="small">é»é¸æ—¥æœŸæŸ¥çœ‹ç•¶æ—¥è¨˜éŒ„ï¼ˆåŒ…å« METs & å¡è·¯é‡Œï¼‰</div>
        </div>
        <div class="calendar-wrap">
          <div class="cal-panel card" style="padding:10px">
            <div class="cal-grid" id="calGrid"></div>
          </div>
          <div class="side-panel card">
            <div class="label">ç•¶æ—¥è¨˜éŒ„</div>
            <div id="dayEvents" class="small">è«‹é»é¸æ—¥æœŸ</div>
          </div>
        </div>
      </section>
    </section>

    <!-- MET PAGE -->
    <section id="page-met" class="tab-page">
      <section class="card">
        <div class="label">æ¯é€± MET-min è¶¨å‹¢ï¼ˆè©³ç´°ï¼‰</div>
        <div class="card chart-card">
          <canvas id="weekChart" style="width:100%;height:100%"></canvas>
        </div>
      </section>
    </section>
  </main>

  <div id="hint" class="hint">æŒ‰ä¸€ä¸‹éº¥å…‹é¢¨ï¼ˆä¸€æ¬¡ï¼‰å–å¾—æ¬Šé™ä¸¦é–‹å§‹å•è¨ºï¼›éº¥å…‹é¢¨æœƒåœ¨æ‰€æœ‰å•é¡Œå•å®Œå¾Œè‡ªå‹•é—œé–‰ã€‚</div>

  <div id="console" class="console">[ç³»çµ±] æº–å‚™ä¸­â€¦</div>

  <div id="toast" class="toast">å·²åŠ å…¥è¡Œäº‹æ›†</div>

  <div class="fab-bar">
    <div class="nav-card">
      <div class="nav-btn active" id="tabSurveyBtn"><div style="font-size:20px">ğŸ©º</div><div style="font-size:12px">å•è¨º</div></div>
      <div class="nav-btn" id="tabCalendarBtn"><div style="font-size:20px">ğŸ“…</div><div style="font-size:12px">è¡Œäº‹æ›†</div></div>
      <div class="nav-btn" id="tabMetBtn"><div style="font-size:20px">ğŸ“ˆ</div><div style="font-size:12px">MET è¶¨å‹¢</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <button id="micBtn" class="fab">ğŸ¤</button>
    </div>
  </div>

  <!-- equipment info modal -->
  <div id="equipInfo" class="equip-info">
    <h3 id="equipTitle">å™¨æèªªæ˜</h3>
    <div id="equipText">å…§å®¹</div>
    <div style="margin-top:12px;text-align:right"><button id="closeEquip" class="button ghost">é—œé–‰</button></div>
  </div>
<script>
/* ================= Final å…¨åŸŸç‹€æ…‹èˆ‡å•è¨ºé¡Œåº« ================= */
const steps = [
  {key:'gender', prompt:'è«‹å•æ‚¨çš„æ€§åˆ¥ï¼Œè«‹èªªã€Œç”·ã€æˆ–ã€Œå¥³ã€ã€‚', type:'select', map:{'ç”·':'male','å¥³':'female'}},
  {key:'age', prompt:'è«‹å•æ‚¨çš„å¹´é½¡å¹¾æ­²ï¼Ÿ', type:'number'},
  {key:'height', prompt:'è«‹å•æ‚¨çš„èº«é«˜å¤šå°‘å…¬åˆ†ï¼Ÿ', type:'number'},
  {key:'weight', prompt:'è«‹å•æ‚¨çš„é«”é‡å¤šå°‘å…¬æ–¤ï¼Ÿ', type:'number'},
  {key:'goal', prompt:'è«‹å•æ‚¨çš„ä¸»è¦é‹å‹•ç›®æ¨™ç‚ºä½•ï¼Ÿè«‹èªªã€Œæ¸›é‡ã€ã€ã€Œå¿ƒè‚ºã€ã€ã€Œè‚ŒåŠ›ã€æˆ–ã€Œå¥åº·ç¶­æŒã€ã€‚', type:'select', map:{'æ¸›é‡':'weight','å¿ƒè‚º':'cardio','è‚ŒåŠ›':'strength','å¥åº·':'maintain'}},
  {key:'current_days', prompt:'ç›®å‰æ¯é€±æ‚¨å¤§ç´„é‹å‹•å¹¾å¤©ï¼Ÿè«‹èªªæ•¸å­—ã€‚', type:'number'},
  {key:'future_days', prompt:'æœªä¾†æ‚¨å¸Œæœ›æ¯é€±å®‰æ’å¹¾å¤©é‹å‹•ï¼Ÿè«‹èªªæ•¸å­—ã€‚', type:'number'},
  {key:'experience', prompt:'æ‚¨çš„é‹å‹•ç¶“é©—ç‚ºä½•ï¼Ÿè«‹èªªã€Œç„¡ç¶“é©—ã€ã€ã€Œåˆå­¸ã€ã€ã€Œæœ‰ç¶“é©—ã€æˆ–ã€Œç«¶æŠ€ã€ã€‚', type:'text'},
  {key:'chronic', prompt:'æ˜¯å¦è¢«é†«å¸«è¨ºæ–·æœ‰æ…¢æ€§ç—…ï¼Ÿè«‹èªªã€Œæœ‰ã€æˆ–ã€Œæ²’æœ‰ã€ã€‚', type:'select', map:{'æœ‰':'yes','æ²’æœ‰':'no','ç„¡':'no'}},
  {key:'chronic_type', prompt:'è‹¥æœ‰ï¼Œè«‹èªªæ˜æ˜¯å“ªä¸€ç¨®æ…¢æ€§ç—…ï¼Œä¾‹å¦‚ã€Œå¿ƒè¡€ç®¡ã€ã€ã€Œé«˜è¡€å£“ã€ã€ã€Œç³–å°¿ç—…ã€ã€ã€Œè…è‡Ÿã€ç­‰ã€‚', type:'text'},
  {key:'asthma', prompt:'æ˜¯å¦æœ‰æ°£å–˜æˆ–å‘¼å¸ç›¸é—œå•é¡Œï¼Ÿè«‹èªªã€Œæœ‰ã€æˆ–ã€Œæ²’æœ‰ã€ã€‚', type:'select', map:{'æœ‰':'yes','æ²’æœ‰':'no'}},
  {key:'knee', prompt:'è†è“‹æ˜¯å¦æœƒç–¼ç—›ï¼Ÿè«‹èªªã€Œè†è“‹ç—›ã€æˆ–ã€Œæ²’æœ‰ã€ã€‚', type:'select', map:{'è†è“‹ç—›':'yes','ç—›':'yes','æœ‰ç—›':'yes','æ²’æœ‰':'no','æ²’ç—›':'no'}},
  {key:'goal_weeks', prompt:'æ‚¨çš„ç›®æ¨™å¸Œæœ›åœ¨å¹¾é€±å…§é”æˆï¼Ÿè«‹èªªæ•¸å­—ï¼Œä¾‹å¦‚åäºŒã€‚', type:'number'}
];

let currentIndex = 0;
let answers = {};
let recognition = null;
let isListening = false;
let autoRecording = false;
let suppressRecognition = false;
let waitingForTTS = false;
const currentLang = 'cmn-Hant-TW'; // å›ºå®šç‚ºè¯èª
const synth = window.speechSynthesis;

/* DOM refs */
const consoleEl = document.getElementById('console');
const micBtn = document.getElementById('micBtn');
const hintEl = document.getElementById('hint');
const answersView = document.getElementById('answersView');
const progressEl = document.getElementById('progress');
const voiceState = document.getElementById('voiceState');
const prescriptionCard = document.getElementById('prescriptionCard');
const rxSummary = document.getElementById('rxSummary');
const rxPlan = document.getElementById('rxPlan');
const recommendList = document.getElementById('recommendList');
const calGrid = document.getElementById('calGrid');
const calHeader = document.getElementById('calHeader');
const dayEvents = document.getElementById('dayEvents');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const tabSurveyBtn = document.getElementById('tabSurveyBtn');
const tabCalendarBtn = document.getElementById('tabCalendarBtn');
const tabMetBtn = document.getElementById('tabMetBtn');
const pageSurvey = document.getElementById('page-survey');
const pageCalendar = document.getElementById('page-calendar');
const pageMet = document.getElementById('page-met');
const toastEl = document.getElementById('toast');
const equipInfo = document.getElementById('equipInfo');
const equipTitle = document.getElementById('equipTitle');
const equipText = document.getElementById('equipText');
const closeEquip = document.getElementById('closeEquip');
const addAllBtn = document.getElementById('addAllBtn');
const exportAllBtn = document.getElementById('exportAllBtn');
const weekCtx = document.getElementById('weekChart').getContext('2d');
let weekChart = null;
let viewDate = new Date();

/* ---------- helpers ---------- */
function log(msg, err=false){ const t=new Date().toLocaleTimeString(); consoleEl.innerText = `[${t}] ${msg}\n` + consoleEl.innerText; }
function updateProgress(){ progressEl.innerText = `ç¬¬ ${Math.min(currentIndex+1, steps.length)} é¡Œ / ${steps.length} é¡Œ`; }
function prettyAnswers(){
  let s = '';
  s += `ğŸ‘¤ æ€§åˆ¥ï¼š${answers.gender==='male'?'ç”·æ€§':answers.gender==='female'?'å¥³æ€§':'æœªå¡«'}\n`;
  if(answers.age) s += `ğŸ‚ å¹´é½¡ï¼š${answers.age} æ­²\n`;
  if(answers.height) s += `ğŸ“ èº«é«˜ï¼š${answers.height} å…¬åˆ†\n`;
  if(answers.weight) s += `âš– é«”é‡ï¼š${answers.weight} å…¬æ–¤\n`;
  if(answers.goal) s += `ğŸ¯ é‹å‹•ç›®æ¨™ï¼š${answers.goal}\n`;
  if(answers.current_days) s += `ğŸ“… ç›®å‰æ¯é€±é‹å‹•ï¼š${answers.current_days} å¤©\n`;
  if(answers.future_days) s += `ğŸ“… å¸Œæœ›æ¯é€±å®‰æ’ï¼š${answers.future_days} å¤©\n`;
  if(answers.experience) s += `ğŸ‹ï¸ ç¶“é©—ï¼š${answers.experience}\n`;
  s += `ğŸ’Š æ…¢æ€§ç—…ï¼š${answers.chronic==='yes'?'æœ‰':'æ²’æœ‰'}\n`;
  if(answers.chronic==='yes' && answers.chronic_type) s += `ã€€ã€€é¡å‹ï¼š${answers.chronic_type}\n`;
  s += `ğŸŒ¬ æ°£å–˜ï¼š${answers.asthma==='yes'?'æœ‰':'æ²’æœ‰'}\n`;
  s += `ğŸ¦µ è†è“‹ç–¼ç—›ï¼š${answers.knee==='yes'?'æœ‰':'æ²’æœ‰'}\n`;
  if(answers.goal_weeks) s += `â³ ç›®æ¨™æœŸç¨‹ï¼š${answers.goal_weeks} é€±\n`;
  answersView.innerText = s || 'å°šç„¡å•è¨ºè³‡æ–™';
  if(answers.height && answers.weight){
    const h = Number(answers.height); const w = Number(answers.weight);
    if(h && w) document.getElementById('bmi').innerText = 'BMI: ' + (w/((h/100)**2)).toFixed(1);
  }
}

/* ---------- recognition init ---------- */
function initRecognition(lang){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('ç€è¦½å™¨ä¸æ”¯æ´ Web Speech APIï¼Œè«‹ä½¿ç”¨ Chrome ä¸¦æ–¼ HTTPS æˆ– localhost åŸ·è¡Œ'); log('ä¸æ”¯æ´ SpeechRecognition', true); return false; }
  try{
    recognition = new SR();
    recognition.lang = lang || currentLang;
    recognition.interimResults = false;
    recognition.continuous = true;
    recognition.onstart = ()=>{ isListening = true; micBtn.classList.add('listening'); voiceState.innerText='éŒ„éŸ³ä¸­'; log('éŒ„éŸ³å•Ÿå‹•'); };
    recognition.onresult = (e)=>{
      if(suppressRecognition) { log('suppressRecognition - å¿½ç•¥æ­¤çµæœ'); return; }
      const last = e.results[e.results.length-1];
      const text = last[0].transcript.trim();
      log('è¾¨è­˜åˆ°èªéŸ³: ' + text);
      processAnswer(text);
    };
    recognition.onerror = (ev)=>{ log('è¾¨è­˜éŒ¯èª¤: ' + ev.error, true); };
    recognition.onend = ()=>{
      isListening = false; micBtn.classList.remove('listening'); log('recognition.onend');
      if(autoRecording && currentIndex < steps.length && !waitingForTTS){
        setTimeout(()=>{ try{ recognition.start(); } catch(e){ log('restart fail: ' + (e.message||e), true); } }, 300);
      } else {
        voiceState.innerText = 'ç­‰å¾…ä¸­';
      }
    };
    return true;
  } catch(e){
    log('initRecognition ä¾‹å¤–: ' + e.message, true);
    return false;
  }
}

/* ---------- TTS (ä¿®æ­£ç‰ˆï¼Œç¢ºä¿ç©©å®šé‡å•Ÿéº¥å…‹é¢¨) ---------- */
function speak(text, onend){
Â  waitingForTTS = true;
Â  suppressRecognition = true;
Â  
Â  // Explicitly stop recognition before TTS starts to prevent conflict
Â  try{ recognition && recognition.stop(); } catch(e){}

Â  const u = new SpeechSynthesisUtterance(text);
Â  const voices = speechSynthesis.getVoices();
Â  let chosen = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('zh-tw')) || voices[0];
Â  u.voice = chosen;
Â  u.lang = chosen?.lang || 'zh-TW';
Â  u.rate = 1.05;
Â  
Â  u.onend = ()=>{
Â  Â  waitingForTTS = false;
Â  Â  suppressRecognition = false;
Â  Â  log('TTS çµæŸ: ' + text);
Â  Â  
Â  Â  if(typeof onend === 'function') onend();
Â  Â  
Â  Â  // é—œéµä¿®æ­£ï¼šç¢ºä¿ TTS çµæŸå¾Œèƒ½æˆåŠŸæ¥åŠ›å•Ÿå‹•éº¥å…‹é¢¨
Â  Â  if(autoRecording && currentIndex < steps.length){
Â  Â  Â  // å»¶é² 400ms è®“éŸ³é »é€šé“å®Œå…¨é‡‹æ”¾
Â  Â  Â  setTimeout(()=>{ 
Â  Â  Â  Â  try{ 
Â  Â  Â  Â  Â  recognition.start(); 
Â  Â  Â  Â  Â  log('éº¥å…‹é¢¨æˆåŠŸé‡å•Ÿ');
Â  Â  Â  Â  } catch(e){ 
Â  Â  Â  Â  Â  log('éº¥å…‹é¢¨é‡å•Ÿå¤±æ•—ï¼Œå˜—è©¦å†æ¬¡å‘¼å«: ' + (e.message||e), true); 
Â  Â  Â  Â  Â  // If the first restart fails, try again after a brief moment (failsafe)
Â  Â  Â  Â  Â  setTimeout(() => { try{ recognition.start(); } catch(e) {} }, 500); 
Â  Â  Â  Â  } 
Â  Â  Â  }, 400);
Â  Â  }
Â  };
Â  synth.cancel(); synth.speak(u);
}
// (è«‹ä¿ç•™å…¶ä»–æ‰€æœ‰ç¨‹å¼ç¢¼ä¸è®Š)

/* ---------- parsing helpers ---------- */
function parseChineseNumber(text){
  const m = text.match(/\d+/); if(m) return Number(m[0]);
  const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'ç™¾':100};
  let val=0,t=0,found=false;
  for(const ch of text){ if(map[ch]!==undefined){ found=true; if(map[ch]===10||map[ch]===100){ if(t===0) t=1; val += t * map[ch]; t=0;} else { t = t*10 + map[ch]; } } }
  val += t; return found ? val : null;
}
function normalize(t){ return t.replace(/\s+/g,'').replace(/[ï¼Œã€‚,.ã€]/g,'').toLowerCase(); }

/* ---------- processAnswer (continuous) ---------- */
const AGREE_WORDS = ["å¥½","å¯ä»¥","ok","okay","è¡Œ","æ²’å•é¡Œ","å¯ä»¥å–”","å¥½å–”","å¥½å•¦","å°","æ˜¯","å—¯","æ©","å—¯å“¼"];
const NEGATE_WORDS = ["æ²’","æ²’æœ‰","ä¸","ä¸è¦","ä¸è¡Œ","ç„¡"];

function processAnswer(recText){
  if(currentIndex >= steps.length) return;
  const step = steps[currentIndex];
  let val = null;
  const raw = recText.trim();
  const c = normalize(raw);

  // quick agree/negation handling
  const containsAgree = AGREE_WORDS.some(w => c.includes(w));
  const containsNeg = NEGATE_WORDS.some(w => c.includes(w));

  if(step.type === 'select' && step.map){
    if(step.map && (Object.values(step.map).includes('yes') || Object.values(step.map).includes('no'))){
      if(containsAgree && !containsNeg) val = 'yes';
      else if(containsNeg && !containsAgree) val = 'no';
    }
  }

  if(val === null){
    if(step.type==='number'){ val = parseChineseNumber(c); }
    else if(step.type==='select' && step.map){
      for(const k in step.map){
        if(c.includes(k)) { val = step.map[k]; break; }
      }
      if(val===null){
        if(c.includes('æœ‰')) val='yes';
        if(c.includes('æ²’æœ‰')||c.includes('ç„¡')) val='no';
        if(c.includes('æ¸›é‡')) val='weight';
        if(c.includes('å¿ƒè‚º')) val='cardio';
        if(c.includes('è‚ŒåŠ›')) val='strength';
        if(c.includes('ç¶­æŒ')) val='maintain';
      }
    } else { val = raw; }
    if(val===null && step.type==='number'){
      const num = parseFloat(raw);
      if(!isNaN(num)) val = num;
    }
  }

  if(val===null){
    log('ç„¡æ³•è§£æç­”æ¡ˆï¼Œè«‹å†èªªä¸€æ¬¡');
    speak('æŠ±æ­‰ï¼Œæ²’è½æ¸…æ¥šï¼Œè«‹å†èªªä¸€æ¬¡ã€‚');
    return;
  }

  answers[step.key] = val;
  prettyAnswers();

  if(step.key === 'chronic' && val === 'no'){
    delete answers['chronic_type'];
    currentIndex++; // skip chronic_type
  }

  currentIndex++;
  updateProgress();

  if(currentIndex < steps.length){
    const nextQ = steps[currentIndex].prompt;
    log('ä¸‹ä¸€é¡Œï¼š' + nextQ);
    speak('å¥½çš„ï¼Œå†è«‹æ‚¨å›ç­”ï¼š' + nextQ);
  } else {
    log('å•è¨ºå®Œæˆï¼Œç”Ÿæˆè™•æ–¹...');
    try{ recognition && recognition.stop(); } catch(e){}
    autoRecording = false;
    consoleEl.style.display = 'none';
    hintEl.style.display = 'none';
    voiceState.innerText = 'å·²çµæŸ';
    speak('å•è¨ºå®Œæˆï¼Œæ•™ç·´æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆå»ºè­°ã€‚');
    setTimeout(()=> generatePrescription(), 700);
  }
}

/* ---------- equipment info content ---------- */
const equipInfos = {
  'è·‘æ­¥æ©Ÿ': { title:'è·‘æ­¥æ©Ÿ - æ³¨æ„äº‹é …', text:'æŠ¬é ­ã€æ ¸å¿ƒç©©å®šã€æ­¥å¹…é©ä¸­ã€‚è‹¥è†è“‹ç—›æˆ–å¿ƒè¡€ç®¡ç–¾ç—…é ˆä¿å®ˆï¼›ç†±èº« 8-10 åˆ†é˜ï¼Œå¡åº¦/é€Ÿåº¦é€æ­¥å¢åŠ ã€‚' },
  'æ©¢åœ“æ©Ÿ': { title:'æ©¢åœ“æ©Ÿ - æ³¨æ„äº‹é …', text:'ä½è¡æ“Šã€ç¯€å¥ç©©å®šï¼Œé©åˆè†è“‹ä¸é©è€…ï¼›ä¿æŒè¸æ¿å¹³é †ã€‚' },
  'åˆ’èˆ¹æ©Ÿ': { title:'åˆ’èˆ¹æ©Ÿ - æ³¨æ„äº‹é …', text:'å‹•ä½œé †åºï¼šè…¿â†’è»€å¹¹â†’æ‰‹ã€‚æ ¸å¿ƒæ”¶ç·Šï¼Œé¿å…ç”¨è‚©è†€æ‹‰ã€‚è…°ç—›è€…é™ä½é˜»åŠ›ã€‚' },
  'ç«‹å¼è…³è¸è»Š': { title:'ç«‹å¼è…³è¸è»Š - æ³¨æ„äº‹é …', text:'é©åˆé–“æ­‡è¨“ç·´ï¼Œåº§æ¤…èª¿æ•´æ­£ç¢ºï¼Œé¿å…è†è“‹å…§æ‰£ï¼›æ³¨æ„è¸é »ã€‚' },
  'è‡¥å¼è…³è¸è»Š': { title:'è‡¥å¼è…³è¸è»Š - æ³¨æ„äº‹é …', text:'éå¸¸ä½è¡æ“Šï¼Œé©åˆå¾©å¥èˆ‡åˆå­¸è€…ï¼Œåº§æ¤…èˆ‡é èƒŒè¦æ”¯æ’è…°éƒ¨ã€‚' }
};
function showEquipInfoByName(name){
  const info = equipInfos[name] || {title:name, text:'ç„¡é¡å¤–è³‡è¨Š'};
  equipTitle.innerText = info.title;
  equipText.innerText = info.text;
  equipInfo.style.display = 'block';
}
closeEquip.addEventListener('click', ()=> equipInfo.style.display = 'none');

/* ---------- prescription generation & display ---------- */
function generatePrescription(){
  const h = Number(answers.height) || null;
  const w = Number(answers.weight) || 70;
  const currDays = Number(answers.current_days) || 0;
  const futureDays = Number(answers.future_days) || currDays;
  const exp = (answers.experience||'').toString().toLowerCase();
  const chronic = answers.chronic==='yes';
  const chronic_type = (answers.chronic_type||'').toString().toLowerCase();
  const knee = answers.knee==='yes';
  const asthma = answers.asthma==='yes';
  const goal = answers.goal || 'ç¶­æŒ';
  const weeks = Number(answers.goal_weeks) || 12;

  let allowed = ['è·‘æ­¥æ©Ÿ','æ©¢åœ“æ©Ÿ','åˆ’èˆ¹æ©Ÿ','ç«‹å¼è…³è¸è»Š','è‡¥å¼è…³è¸è»Š'];
  if(knee) allowed = allowed.filter(x=> x!=='è·‘æ­¥æ©Ÿ' && x!=='ç«‹å¼è…³è¸è»Š');
  if(chronic){
    if(chronic_type.includes('å¿ƒ')||chronic_type.includes('é«˜è¡€å£“')||chronic_type.includes('å¿ƒè¡€ç®¡')){
      allowed = allowed.filter(x=> x!=='è·‘æ­¥æ©Ÿ');
    }
  }
  if(asthma) allowed = allowed.filter(x=> x!=='è·‘æ­¥æ©Ÿ');
  if(allowed.length===0) allowed=['è‡¥å¼è…³è¸è»Š','æ©¢åœ“æ©Ÿ'];

  let intensity='ä¸­ç­‰å¼·åº¦', rpe='RPE 4-6', totalTime=30;
  if(exp.includes('ç„¡') || currDays<=1){ intensity='ä¸­ä½å¼·åº¦'; rpe='RPE 3-5'; totalTime=25; }
  else if(exp.includes('åˆ') || currDays===2 || currDays===3){ intensity='ä¸­ç­‰å¼·åº¦'; rpe='RPE 4-6'; totalTime=30; }
  else if(exp.includes('æœ‰') || currDays>=4){ intensity='ä¸­é«˜å¼·åº¦'; rpe='RPE 5-7'; totalTime=35; }
  else if(exp.includes('ç«¶') || currDays>=5){ intensity='é«˜å¼·åº¦'; rpe='RPE 6-8'; totalTime=40; }
  if(chronic || asthma){ totalTime = Math.max(20, Math.round(totalTime*0.8)); rpe='RPE 3-5ï¼ˆä¿å®ˆï¼‰'; intensity='ä½åˆ°ä¸­ç­‰ï¼ˆä¿å®ˆï¼‰'; }

  const picks = allowed.slice(0, Math.min(4, allowed.length));
  const per = Math.max(8, Math.round(totalTime / picks.length));
  function estimateMets(label){
    if(label.includes('ä½')) return 4.0;
    if(label.includes('ä¸­ä½')) return 4.5;
    if(label.includes('ä¸­é«˜')) return 7.0;
    if(label.includes('ä¸­ç­‰')) return 6.0;
    if(label.includes('é«˜')) return 8.0;
    return 5.0;
  }
  const mets = estimateMets(intensity);

  const recs = picks.map(e=>{
    const duration = per;
    const estCal = Math.round((mets * 3.5 * w / 200) * duration);
    const metMin = Math.round(mets * duration);
    return { equipment:e, duration, intensity, rpe, mets, metMin, estCal, reason:
      e==='è·‘æ­¥æ©Ÿ'?'è€—èƒ½é«˜ã€å¯æ§å¡åº¦èˆ‡é€Ÿåº¦':
      e==='æ©¢åœ“æ©Ÿ'?'ä½è¡æ“Šã€è†è“‹å‹å–„':
      e==='åˆ’èˆ¹æ©Ÿ'?'å…¨èº«å‹•å“¡ã€æé«˜è€—èƒ½':
      e==='ç«‹å¼è…³è¸è»Š'?'é©åˆé–“æ­‡ã€è†è“‹è² æ“”è¼ƒä½':
      e==='è‡¥å¼è…³è¸è»Š'?'éå¸¸ä½è¡æ“Šã€å¾©å¥èˆ‡å¿ƒè‚ºé©åˆ':'' };
  });

  prescriptionCard.style.display = 'block';
  rxSummary.innerHTML = `<div style="font-weight:800">${intensity} | ${rpe} | å»ºè­°ç¸½æ™‚é–“ ${totalTime} åˆ†é˜ | é ä¼° ${recs.reduce((s,r)=>s+r.estCal,0)} Kcal</div>
    <div class="small" style="margin-top:6px">ç›®å‰æ¯é€± ${currDays} å¤©ï¼Œé æœŸæ¯é€± ${futureDays} å¤©ï¼›ç›®æ¨™ ${answers.goal || 'ç¶­æŒ'}ï¼›åˆ†é …å¦‚ä¸‹ï¼š</div>`;

  recommendList.innerHTML = '';
  recs.forEach((r, idx)=>{
    const div = document.createElement('div');
    div.className = 'reco-card';
    const btnId = `addCalBtn_${idx}`;
    div.innerHTML = `
      <div class="reco-left">
        <div style="font-weight:800">${r.equipment} <button class="button ghost" style="margin-left:8px;padding:6px 8px" data-equip="${r.equipment}" onclick="showEquipFromBtn(event)">?</button></div>
        <div class="reco-meta">æ™‚é–“ï¼š${r.duration} åˆ†é˜ | ${r.intensity} | ${r.rpe} | METs: ${r.mets} | MET-min: ${r.metMin} | kcal: ${r.estCal}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button id="${btnId}" class="button">åŠ å…¥è¡Œäº‹æ›†</button>
      </div>
    `;
    recommendList.appendChild(div);

    document.getElementById(btnId).addEventListener('click', ()=> {
      addSingleToCalendar(r, btnId);
    });
  });

  // save last generated
  const last = { recs, summary:{intensity,rpe,totalTime,mets}, answers, date: new Date().toISOString().split('T')[0], ts: Date.now() };
  localStorage.setItem('tsox_lastGenerated', JSON.stringify(last));
  renderCalendar(); renderWeekChart();
}

/* show equip info */
function showEquipFromBtn(ev){ const name = ev.currentTarget.getAttribute('data-equip'); showEquipInfoByName(name); }

/* ---------- calendar (single add & add-all) ---------- */
function loadCalendar(){ return JSON.parse(localStorage.getItem('tsox_calendar') || '{}'); }
function saveCalendarObj(obj){ localStorage.setItem('tsox_calendar', JSON.stringify(obj)); }
function addToCalendar(entry, dateKey){
  const cal = loadCalendar();
  if(!cal[dateKey]) cal[dateKey] = [];
  cal[dateKey].push(entry);
  saveCalendarObj(cal);
  log('å·²åŠ å…¥è¡Œäº‹æ›†ï¼š' + dateKey);
  renderCalendar(); renderWeekChart();
}
function addSingleToCalendar(r, btnId){
  const dateKey = new Date().toISOString().split('T')[0];
  const entry = {
    title: r.equipment,
    totalTime: r.duration,
    mets: r.mets,
    metMin: r.metMin,
    estCal: r.estCal,
    plan: [r],
    answers,
    date: dateKey,
    ts: Date.now()
  };
  addToCalendar(entry, dateKey);
  if(btnId){
    const btn = document.getElementById(btnId);
    if(btn){ btn.classList.add('added-btn'); btn.innerText = 'âœ“ å·²åŠ å…¥'; }
  }
  showToast(`${r.equipment} å·²åŠ å…¥è¡Œäº‹æ›†`);
}

/* add all recs to today */
addAllBtn.addEventListener('click', ()=>{
  const raw = localStorage.getItem('tsox_lastGenerated');
  if(!raw) return alert('å°šç„¡è™•æ–¹å¯åŠ å…¥ï¼Œè«‹å…ˆå®Œæˆå•è¨ºç”Ÿæˆè™•æ–¹');
  const last = JSON.parse(raw);
  last.recs.forEach((r, idx)=>{
    const btnId = `addCalBtn_${idx}`;
    addSingleToCalendar(r, btnId);
  });
  showToast('å…¨éƒ¨é …ç›®å·²åŠ å…¥ä»Šæ—¥è¡Œäº‹æ›†');
});

/* ---------- export all generated (prettier PDF via print) ---------- */
exportAllBtn.addEventListener('click', exportAllGenerated);
function exportAllGenerated(){
  const raw = localStorage.getItem('tsox_lastGenerated');
  if(!raw) return alert('å°šç„¡è™•æ–¹å¯åŒ¯å‡º');
  const e = JSON.parse(raw);
  const dateKey = e.date || new Date().toISOString().split('T')[0];
  const totalMetMin = (e.recs||[]).reduce((s,r)=>s+(r.metMin||0),0);
  const totalKcal = (e.recs||[]).reduce((s,r)=>s+(r.estCal||0),0);

  // prettier HTML for print
  const content = `
    <html><head><meta charset="utf-8"><title>è™•æ–¹ ${dateKey}</title>
    <style>
      :root{--p:#1b5e20;--a:#ff8a65}
      body{font-family: 'Noto Sans TC', Arial, Helvetica, sans-serif; padding:28px; color:#222}
      .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
      h1{color:var(--p);margin:0;font-size:24px}
      .meta{color:#666}
      .card{border-radius:12px;padding:14px;background:#f8fff8;border:1px solid #e6f4ea;margin-bottom:14px}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      th,td{border:1px solid #e0e0e0;padding:8px;text-align:left}
      th{background:linear-gradient(90deg, #f0f7f0, #fff);color:var(--p)}
      .totals{font-weight:800;background:#fffbea}
      .footer{margin-top:20px;color:#555;font-size:13px}
      .logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,var(--p),#2e7d32);display:inline-block;margin-right:10px}
    </style>
    </head><body>
    <div class="header">
      <div style="display:flex;align-items:center">
        <div class="logo"></div>
        <div>
          <h1>T-SOX æ•™ç·´è™•æ–¹</h1>
          <div class="meta">åŒ¯å‡ºæ—¥æœŸï¼š${new Date().toLocaleDateString()} / å—æ¸¬è€…ï¼š${e.answers?.gender||''}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;color:var(--a)">${e.summary?.intensity||''}</div>
        <div class="meta">RPE: ${e.summary?.rpe||''}</div>
      </div>
    </div>

    <div class="card">
      <h3>å•è¨ºæ‘˜è¦</h3>
      <pre>${formatAnswersForExport(e.answers)}</pre>
    </div>

    <div class="card">
      <h3>åˆ†é …è™•æ–¹ï¼ˆå…¨éƒ¨ï¼‰</h3>
      <table>
        <tr><th>#</th><th>å™¨æ</th><th>æ™‚é–“ (min)</th><th>METs</th><th>MET-min</th><th>kcal</th><th>æ³¨æ„</th></tr>
        ${(e.recs||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.equipment}</td><td>${r.duration}</td><td>${r.mets}</td><td>${r.metMin}</td><td>${r.estCal}</td><td>${r.reason}</td></tr>`).join('')}
        <tr class="totals"><td colspan="4">ç¸½è¨ˆ</td><td>${totalMetMin}</td><td>${totalKcal}</td><td></td></tr>
      </table>
    </div>

    <div class="footer">æé†’ï¼šæœ¬è™•æ–¹ç‚ºé‹å‹•å»ºè­°ï¼Œè‹¥æœ‰ä¸é©æˆ–ç´…æ——ç—‡ç‹€ï¼ˆèƒ¸ç—›ã€æšˆçœ©ã€åš´é‡å‘¼å¸å›°é›£ï¼‰è«‹ç«‹å³å°±é†«ã€‚</div>
    </body></html>
  `;
  const w = window.open('','_blank');
  w.document.write(content); w.document.close();
  setTimeout(()=> w.print(),700);
}

/* ---------- calendar render & day events ---------- */
function renderCalendar(){
  const year = viewDate.getFullYear(), month = viewDate.getMonth();
  calHeader.innerText = `${year} / ${month+1}`;
  calGrid.innerHTML = '';
  const first = new Date(year, month, 1);
  const start = first.getDay();
  const dim = new Date(year, month+1, 0).getDate();
  const cal = loadCalendar();
  for(let i=0;i<start;i++){ const blank = document.createElement('div'); blank.className='cal-cell'; calGrid.appendChild(blank); }
  for(let d=1; d<=dim; d++){
    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const events = cal[dateKey] || [];
    const cell = document.createElement('div'); cell.className = 'cal-cell' + (events.length>0 ? ' has' : '');
    const totalMetMin = events.reduce((s,e)=>s + (e.metMin || 0),0);
    const totalKcal = events.reduce((s,e)=>s + (e.estCal || 0),0);
    cell.innerHTML = `<div class="dateNum">${d}</div>` + (events.length>0 ? `<div class="small">${events.length} ç­†</div><div class="small">MET-min:${Math.round(totalMetMin)}</div><div class="small">Kcal:${Math.round(totalKcal)}</div>` : '');
    if(events.length>0) cell.classList.add('has');
    const dot = document.createElement('div'); dot.className='cal-dot'; cell.appendChild(dot);
    cell.addEventListener('click', ()=> showDayEvents(dateKey));
    calGrid.appendChild(cell);
  }
}
function showDayEvents(dateKey){
  const cal = loadCalendar();
  const events = cal[dateKey] || [];
  let html = `<div style="font-weight:800;margin-bottom:8px">${dateKey}</div>`;
  if(events.length===0) html += '<div class="small">ç•¶æ—¥ç„¡ç´€éŒ„</div>';
  else {
    events.forEach((e, idx)=>{
      html += `<div style="border-bottom:1px dashed #eee;padding-bottom:8px;margin-bottom:8px">
        <div style="font-weight:800">${e.title || e.plan?.[0]?.equipment || 'è™•æ–¹'}</div>
        <div class="small">æ™‚é–“ï¼š${e.totalTime || e.plan?.[0]?.duration || ''} åˆ†é˜ | METsï¼š${e.mets || e.plan?.[0]?.mets || ''} | MET-minï¼š${Math.round(e.metMin|| (e.mets* (e.totalTime|| e.plan?.[0]?.duration || 0)))} | kcalï¼š${Math.round(e.estCal|| e.plan?.[0]?.estCal || 0)}</div>
        <div style="margin-top:6px">${(e.plan||[]).map(p=>`<div>${p.equipment}ï¼š${p.duration} åˆ†é˜</div>`).join('')}</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="button ghost" onclick='exportSingle("${dateKey}", ${idx})'>åŒ¯å‡º PDF</button>
          <button class="button" style="background:#d32f2f" onclick='deleteSingle("${dateKey}", ${idx})'>åˆªé™¤</button>
        </div>
      </div>`;
    });
  }
  dayEvents.innerHTML = html;
}

/* export & delete for calendar items */
function exportSingle(dateKey, idx){
  const cal = loadCalendar();
  const e = cal[dateKey][idx];
  const content = `
    <html><head><meta charset="utf-8"><title>è™•æ–¹ ${dateKey}</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;padding:20px}h2{color:#2e7d32}li{margin-bottom:6px}</style>
    </head><body>
    <h2>T-SOX æ•™ç·´è™•æ–¹</h2>
    <div>æ—¥æœŸï¼š${dateKey}</div>
    <div>æ‘˜è¦ï¼š${e.title || ''} | æ™‚é–“ ${e.totalTime || ''} åˆ†é˜ | METs ${e.mets || ''} | MET-min ${e.metMin || ''} | é ä¼° ${e.estCal || ''} kcal</div>
    <h3>ç´°é …</h3><ul>${(e.plan||[]).map(p=>`<li><strong>${p.equipment}</strong>ï¼š${p.duration} åˆ†é˜</li>`).join('')}</ul>
    <h3>å•è¨ºæ‘˜è¦</h3><pre>${formatAnswersForExport(e.answers)}</pre>
    </body></html>`;
  const w = window.open('','_blank'); w.document.write(content); w.document.close(); setTimeout(()=> w.print(),600);
}
function deleteSingle(dateKey, idx){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) return;
  const cal = loadCalendar();
  cal[dateKey].splice(idx,1);
  saveCalendarObj(cal);
  renderCalendar(); showDayEvents(dateKey); renderWeekChart();
}

/* ---------- weekly MET-min chart ---------- */
function getWeekNumber(d){
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}
function aggregateWeeklyMetMin(){
  const cal = loadCalendar();
  const weekly = {};
  for(const dateKey in cal){
    const items = cal[dateKey];
    items.forEach(it=>{
      const d = new Date(dateKey);
      const y = d.getFullYear();
      const w = getWeekNumber(d);
      const ky = `${y}-W${String(w).padStart(2,'0')}`;
      const val = Number(it.metMin || 0);
      weekly[ky] = (weekly[ky] || 0) + val;
    });
  }
  const keys = Object.keys(weekly).sort();
  return {keys, values: keys.map(k=>weekly[k])};
}
function renderWeekChart(){
  const agg = aggregateWeeklyMetMin();
  if(!weekChart){
    weekChart = new Chart(weekCtx, {
      type:'line',
      data:{ labels: agg.keys, datasets:[{ label:'æ¯é€± MET-min', data: agg.values, fill:true, tension:0.2, borderColor:'#2e7d32', backgroundColor:'rgba(46,125,50,0.12)' }] },
      options:{ responsive:true, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{display:false} } }
    });
  } else {
    weekChart.data.labels = agg.keys; weekChart.data.datasets[0].data = agg.values; weekChart.update();
  }
}

/* ---------- toast ---------- */
let toastTimer = null;
function showToast(txt, ms=2000){
  toastEl.innerText = txt;
  toastEl.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ toastEl.classList.remove('show'); }, ms);
}

/* ---------- UI events & nav ---------- */
document.getElementById('btnClear').addEventListener('click', ()=>{ if(confirm('æ¸…é™¤å•è¨ºè³‡æ–™ï¼Ÿ')){ answers={}; currentIndex=0; prettyAnswers(); updateProgress(); document.getElementById('prescriptionCard').style.display='none'; consoleEl.style.display='block'; hintEl.style.display='block'; localStorage.removeItem('tsox_lastGenerated'); } });

document.getElementById('prevMonth').addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()-1); renderCalendar(); });
document.getElementById('nextMonth').addEventListener('click', ()=>{ viewDate.setMonth(viewDate.getMonth()+1); renderCalendar(); });

tabSurveyBtn.addEventListener('click', ()=> navTo('survey'));
tabCalendarBtn.addEventListener('click', ()=> navTo('calendar'));
tabMetBtn.addEventListener('click', ()=> navTo('met'));

function navTo(p){
  document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.tab-page').forEach(tp=>tp.classList.remove('active'));
  if(p==='survey'){ tabSurveyBtn.classList.add('active'); pageSurvey.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }
  if(p==='calendar'){ tabCalendarBtn.classList.add('active'); pageCalendar.classList.add('active'); window.scrollTo({top:200,behavior:'smooth'}); }
  if(p==='met'){ tabMetBtn.classList.add('active'); pageMet.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); renderWeekChart(); }
}

/* ---------- main mic button ---------- */
micBtn.addEventListener('click', async ()=>{
  if(!recognition){
    const ok = initRecognition(currentLang || 'cmn-Hant-TW');
    if(!ok) return;
  }
  if(!autoRecording){
    autoRecording = true;
    log('ä½¿ç”¨è€…å•Ÿå‹•å•è¨ºä¸¦é–‹å•Ÿéº¥å…‹é¢¨ï¼ˆcontinuousï¼‰');
    currentIndex = 0; answers = {}; prettyAnswers(); updateProgress();
    try{ recognition.start(); } catch(e){ log('recognition.start() å¤±æ•—: ' + (e.message||e), true); }
    // speak first question (gentle)
    speak('å¥½çš„ï¼Œæˆ‘å€‘é–‹å§‹å•è¨ºå›‰ã€‚è«‹å…ˆå›ç­”ä¸‹ä¸€é¡Œï¼š' + steps[0].prompt);
  } else {
    if(isListening){ try{ recognition.stop(); }catch(e){}; log('æ‰‹å‹•åœæ­¢éŒ„éŸ³'); showToast('å·²æš«åœéŒ„éŸ³'); }
    else { try{ recognition.start(); }catch(e){ log('start fail: ' + (e.message||e), true); } log('æ‰‹å‹•å•Ÿå‹•éŒ„éŸ³'); showToast('ç¹¼çºŒéŒ„éŸ³'); }
  }
});

/* ---------- export all calendar ---------- */
document.getElementById('btnExportCalendar')?.addEventListener('click', ()=> exportAllCalendar());
function exportAllCalendar(){
  const cal = loadCalendar();
  const all = [];
  for(const d in cal) all.push(...cal[d]);
  if(!all.length) { alert('è¡Œäº‹æ›†ç„¡ç´€éŒ„'); return; }
  const content = `
    <html><head><meta charset="utf-8"><title>å…¨éƒ¨è™•æ–¹åŒ¯å‡º</title>
    <style>body{font-family:Arial,Helvetica,sans-serif;padding:20px}h2{color:#2e7d32}li{margin-bottom:6px}</style>
    </head><body><h2>å…¨éƒ¨è¡Œäº‹æ›†åŒ¯å‡º</h2>
    ${all.map(e=>`<div style="margin-bottom:12px"><div>${e.date||''} - ${e.title||''} | ${e.totalTime||''} åˆ†é˜ | ${e.estCal||''} kcal</div></div>`).join('')}
    </body></html>`;
  const w = window.open('','_blank'); w.document.write(content); w.document.close(); setTimeout(()=> w.print(),600);
}

/* ---------- format answers for export ---------- */
function formatAnswersForExport(ans){
  if(!ans) return '';
  let s = '';
  s += `æ€§åˆ¥ï¼š${ans.gender||''}\n`;
  s += `å¹´é½¡ï¼š${ans.age||''}\n`;
  s += `èº«é«˜ï¼š${ans.height||''}\n`;
  s += `é«”é‡ï¼š${ans.weight||''}\n`;
  s += `é‹å‹•ç›®æ¨™ï¼š${ans.goal||''}\n`;
  s += `ç›®å‰æ¯é€±é‹å‹•ï¼š${ans.current_days||''}\n`;
  s += `æœªä¾†æ¯é€±ç›®æ¨™ï¼š${ans.future_days||''}\n`;
  s += `ç¶“é©—ï¼š${ans.experience||''}\n`;
  s += `æ…¢æ€§ç—…ï¼š${ans.chronic||''} ${ans.chronic_type||''}\n`;
  s += `æ°£å–˜ï¼š${ans.asthma||''}\n`;
  s += `è†è“‹ï¼š${ans.knee||''}\n`;
  s += `ç›®æ¨™é€±æ•¸ï¼š${ans.goal_weeks||''}\n`;
  return s;
}

/* ---------- clear calendar ---------- */
document.getElementById('btnClearCalendar')?.addEventListener('click', ()=>{
  if(!confirm('ç¢ºå®šæ¸…ç©ºæ•´å€‹è¡Œäº‹æ›†ï¼Ÿ')) return;
  localStorage.removeItem('tsox_calendar');
  renderCalendar(); renderWeekChart();
});

/* ---------- calendar storage helpers ---------- */
function loadCalendar(){ return JSON.parse(localStorage.getItem('tsox_calendar') || '{}'); }
function saveCalendarObj(obj){ localStorage.setItem('tsox_calendar', JSON.stringify(obj)); }

/* ---------- init ---------- */
updateProgress(); renderCalendar(); renderWeekChart(); log('ç³»çµ±å°±ç·’ã€‚è«‹æŒ‰éº¥å…‹é¢¨é–‹å§‹ï¼ˆç¬¬ä¸€æ¬¡æœƒè©¢å•æ¬Šé™ï¼‰');

</script>
</body>
</html>

